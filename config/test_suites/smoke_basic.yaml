test_suite:
  name: "Basic Smoke Test"
  timeout: 600

  tests:
    - id: "boot_complete"
      name: "開機完成驗證"
      type: "adb_check"
      command: "getprop sys.boot_completed"
      expected: "1"

    - id: "display_normal"
      name: "螢幕顯示正常"
      type: "screenshot_llm"
      prompt: "螢幕是否正常顯示？是否有異常色塊或花屏？"
      pass_criteria: "normal"

    - id: "touch_responsive"
      name: "觸控回應"
      type: "adb_shell"
      command: "dumpsys input | grep -iE 'touchscreen|touch_mt'"
      expected_pattern: "(TOUCHSCREEN|TOUCH_MT)"

    - id: "wifi_connected"
      name: "WiFi 連線"
      type: "adb_shell"
      command: "cmd wifi status"
      expected_contains: "Wifi is connected"

    - id: "internet_access"
      name: "網路存取"
      type: "adb_shell"
      command: "ping -c 3 8.8.8.8"
      expected_pattern: "[1-3] received"
      depends_on: "wifi_connected"

    - id: "sim_status"
      name: "SIM 卡狀態"
      type: "adb_shell"
      command: "dumpsys telephony.registry | grep mServiceState"
      expected_not_contains: "OUT_OF_SERVICE"
      requires:
        device_capability: "has_sim"

    - id: "camera_available"
      name: "相機可用"
      type: "adb_shell"
      command: "dumpsys media.camera | grep 'Number of camera devices'"
      expected_pattern: "Number of camera devices: [1-9]"

    - id: "audio_output"
      name: "音效輸出"
      type: "adb_shell"
      command: "dumpsys audio | grep 'Devices:' | head -5"
      expected_pattern: "(speaker|earpiece)"

    # --- GPS ---
    - id: "gps_provider"
      name: "GPS Provider 可用"
      type: "adb_shell"
      command: "dumpsys location | grep 'gps provider'"
      expected_contains: "gps provider"

    - id: "gps_enabled"
      name: "GPS 定位已開啟"
      type: "adb_shell"
      command: "settings get secure location_mode"
      expected_pattern: "^[1-3]$"

    # --- 藍牙 ---
    - id: "bluetooth_enabled"
      name: "藍牙已啟用"
      type: "adb_shell"
      command: "dumpsys bluetooth_manager | grep 'enabled'"
      expected_contains: "enabled"

    - id: "bluetooth_adapter"
      name: "藍牙 Adapter 存在"
      type: "adb_shell"
      command: "dumpsys bluetooth_manager | grep 'name:'"
      expected_pattern: "name:.*"

    - id: "bluetooth_address"
      name: "藍牙 MAC 位址有效"
      type: "adb_shell"
      command: "dumpsys bluetooth_manager | grep 'address:'"
      expected_pattern: "address: [0-9A-Fa-fXx]{2}:"

    # --- NFC ---
    - id: "nfc_enabled"
      name: "NFC 已啟用"
      type: "adb_shell"
      command: "dumpsys nfc | grep 'mState='"
      expected_contains: "on"

    # nfc_adapter 已合併到 nfc_enabled，移除冗餘測試

    # --- 感測器 ---
    - id: "sensor_accelerometer"
      name: "加速度計感測器"
      type: "adb_shell"
      command: "dumpsys sensorservice | grep -i 'accelerometer.*Non-wakeup'"
      expected_pattern: "sensor\\.accelerometer"

    - id: "sensor_gyroscope"
      name: "陀螺儀感測器"
      type: "adb_shell"
      command: "dumpsys sensorservice | grep -i 'gyroscope.*Non-wakeup'"
      expected_pattern: "sensor\\.gyroscope"

    # --- 儲存與記憶體 ---
    - id: "storage_available"
      name: "內部儲存可用"
      type: "adb_shell"
      command: "df /data | awk 'NR==2{print $4}'"
      expected_pattern: "[0-9]{7,}"

    - id: "memory_available"
      name: "記憶體可用量正常"
      type: "adb_shell"
      command: "cat /proc/meminfo | grep MemAvailable"
      expected_pattern: "MemAvailable:\\s+[1-9][0-9]+ kB"

    # --- 螢幕亮度與自動旋轉 ---
    - id: "brightness_settable"
      name: "螢幕亮度可設定"
      type: "adb_shell"
      command: "settings get system screen_brightness"
      expected_pattern: "^[0-9]+$"

    - id: "auto_rotate"
      name: "自動旋轉功能"
      type: "adb_shell"
      command: "settings get system accelerometer_rotation"
      expected_pattern: "^[01]$"

    # --- USB 與充電 ---
    - id: "battery_status"
      name: "電池狀態正常"
      type: "adb_shell"
      command: "dumpsys battery | grep 'status'"
      expected_pattern: "status: [2-5]"

    - id: "charging_connected"
      name: "充電連線狀態"
      type: "adb_shell"
      command: "dumpsys battery | grep 'powered'"
      expected_pattern: ".*powered: true"

    # --- 系統穩定性 ---
    - id: "no_system_crash"
      name: "無系統崩潰"
      type: "adb_shell"
      command: "logcat -b crash -d | grep 'FATAL EXCEPTION' | wc -l"
      expected_pattern: "^0$"

    - id: "selinux_enforcing"
      name: "SELinux 模式檢查"
      type: "adb_shell"
      command: "getenforce"
      expected_pattern: "^(Enforcing|Permissive)$"

    - id: "dns_resolution"
      name: "DNS 解析正常"
      type: "adb_shell"
      command: "ping -c 1 -W 5 google.com"
      expected_pattern: "[1] received"
      depends_on: "wifi_connected"
      retry: 2
      retry_delay: 3

    - id: "surfaceflinger"
      name: "SurfaceFlinger 運行中"
      type: "adb_shell"
      command: "service check SurfaceFlinger"
      expected_contains: "found"

    - id: "system_server"
      name: "Activity Manager 正常"
      type: "adb_shell"
      command: "dumpsys activity | head -1"
      expected_contains: "ACTIVITY MANAGER"

    # === 功能測試：相機 ===
    - id: "camera_rear_capture"
      name: "後鏡頭拍照"
      type: "camera"
      action: "capture_photo"
      params:
        camera: "back"
        wait_seconds: 5
      depends_on: "camera_available"

    - id: "camera_front_capture"
      name: "前鏡頭拍照"
      type: "camera"
      action: "capture_photo"
      params:
        camera: "front"
        wait_seconds: 5
      depends_on: "camera_available"

    - id: "camera_image_quality"
      name: "照片品質驗證"
      type: "camera"
      action: "verify_latest_photo"
      params:
        verify_prompt: "照片是否清晰、非全黑、非全白、無明顯色偏？"
      depends_on: "camera_rear_capture"

    # === 功能測試：簡訊 ===
    - id: "network_type"
      name: "行動網路類型"
      type: "telephony"
      action: "check_signal"
      params:
        expected_data_type: "LTE|NR"
      requires:
        device_capability: "has_sim"
      depends_on: "sim_status"

    - id: "sms_send"
      name: "SMS 簡訊發送"
      type: "telephony"
      action: "send_sms"
      params:
        to_number: "${PEER_PHONE_NUMBER}"
        body: "smoke-test-outbound-{timestamp}"
      requires:
        device_capability: "has_sim"
      depends_on: "sim_status"

    - id: "sms_receive"
      name: "SMS 簡訊接收"
      type: "telephony"
      action: "receive_sms"
      params:
        body: "smoke-test-inbound-{timestamp}"
        timeout: 30
      requires:
        device_capability: "has_sim"
      depends_on: "sms_send"

    # === 功能測試：撥打電話 ===
    - id: "phone_call"
      name: "撥打電話"
      type: "telephony"
      action: "make_call"
      params:
        to_number: "${PEER_PHONE_NUMBER}"
        call_duration: 5
      requires:
        device_capability: "has_sim"
      depends_on: "sim_status"

    # === 功能測試：WiFi 掃描 ===
    - id: "wifi_scan"
      name: "WiFi 掃描"
      type: "wifi"
      action: "scan"
      depends_on: "wifi_connected"

    - id: "wifi_scan_ssid"
      name: "WiFi 尋找指定 SSID"
      type: "wifi"
      action: "scan_for_ssid"
      params:
        expected_ssid: "${WIFI_SSID}"
      depends_on: "wifi_scan"

    # === 功能測試：WiFi 進階 (Tier 1) ===
    - id: "wifi_toggle"
      name: "WiFi 開關切換"
      type: "wifi"
      action: "toggle"
      depends_on: "wifi_connected"

    - id: "wifi_connection_info"
      name: "WiFi 連線品質"
      type: "wifi"
      action: "connection_info"
      params:
        min_rssi: -80
      depends_on: "wifi_toggle"

    - id: "wifi_dhcp"
      name: "WiFi DHCP 分配"
      type: "wifi"
      action: "dhcp_info"
      depends_on: "wifi_toggle"

    # === 功能測試：WiFi 進階 (Tier 2) ===
    - id: "wifi_5ghz"
      name: "WiFi 5GHz 支援"
      type: "wifi"
      action: "is_5ghz_supported"
      depends_on: "wifi_connected"

    - id: "wifi_p2p"
      name: "WiFi P2P 支援"
      type: "wifi"
      action: "is_p2p_supported"
      depends_on: "wifi_connected"

    - id: "wifi_aware"
      name: "WiFi Aware 支援"
      type: "wifi"
      action: "is_aware_available"
      depends_on: "wifi_connected"

    - id: "wifi_hotspot"
      name: "WiFi 熱點開關"
      type: "wifi"
      action: "hotspot"
      depends_on: "wifi_toggle"

    # === 功能測試：BLE 掃描 ===
    - id: "ble_scan"
      name: "BLE 裝置掃描"
      type: "bluetooth"
      action: "ble_scan"
      params:
        scan_duration: 5
      depends_on: "bluetooth_enabled"

    # === 功能測試：藍牙進階 (Tier 1) ===
    - id: "bt_toggle"
      name: "藍牙開關切換"
      type: "bluetooth"
      action: "toggle"
      depends_on: "bluetooth_enabled"

    - id: "bt_classic_scan"
      name: "Classic BT 掃描"
      type: "bluetooth"
      action: "classic_scan"
      depends_on: "bt_toggle"

    # === 功能測試：藍牙進階 (Tier 2) ===
    - id: "bt_adapter_info"
      name: "BT Adapter 資訊"
      type: "bluetooth"
      action: "adapter_info"
      depends_on: "bt_toggle"

    - id: "bt_paired_devices"
      name: "已配對裝置列表"
      type: "bluetooth"
      action: "paired_devices"
      depends_on: "bt_toggle"

    - id: "ble_advertise"
      name: "BLE 廣播測試"
      type: "bluetooth"
      action: "ble_advertise"
      params:
        duration: 3
      depends_on: "bt_toggle"

    - id: "bt_le_audio"
      name: "LE Audio 支援"
      type: "bluetooth"
      action: "le_audio_supported"
      depends_on: "bluetooth_enabled"

    # === 功能測試：音頻播放 ===
    - id: "audio_playback"
      name: "音頻播放"
      type: "audio"
      action: "play_and_check"
      params:
        play_duration: 2

    # === 功能測試：音頻進階 (Tier 1) ===
    - id: "audio_volume"
      name: "音量控制"
      type: "audio"
      action: "volume_control"

    - id: "audio_microphone"
      name: "麥克風靜音控制"
      type: "audio"
      action: "microphone_test"

    - id: "audio_devices"
      name: "音訊裝置偵測"
      type: "audio"
      action: "list_devices"

    - id: "audio_route"
      name: "音訊路由資訊"
      type: "audio"
      action: "audio_route"

    # === 功能測試：網路下載 ===
    - id: "download_wifi"
      name: "HTTP 下載 (WiFi)"
      type: "network"
      action: "http_download"
      params:
        network_mode: "wifi"
        url: "https://www.google.com/generate_204"
      depends_on: "wifi_connected"

    - id: "download_mobile"
      name: "HTTP 下載 (行動數據)"
      type: "network"
      action: "http_download"
      params:
        network_mode: "mobile"
      requires:
        device_capability: "has_sim"
      depends_on: "sim_status"

    - id: "tcp_connect"
      name: "TCP 連通性"
      type: "network"
      action: "tcp_connect"
      params:
        host: "8.8.8.8"
        port: 443
      depends_on: "wifi_connected"

    # === 功能測試：Telephony 進階 ===
    - id: "voice_network_type"
      name: "語音網路類型"
      type: "telephony"
      action: "check_voice_type"
      requires:
        device_capability: "has_sim"
      depends_on: "sim_status"

    - id: "sim_info"
      name: "SIM 卡資訊"
      type: "telephony"
      action: "sim_info"
      requires:
        device_capability: "has_sim"
      depends_on: "sim_status"
